<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é»æ·±0905ç”Ÿæ—¥åº”æ´æ±‡æ€»åœ°å›¾</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #f0f4f8 0%, #e6e6ff 100%);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(90deg, #6fa8dc 0%, #3a7bd5 100%);
      color: white;
      padding: 12px 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      margin: 0;
      font-size: 22px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    }
    .stats-bar {
      display: flex;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 4px 12px;
    }
    .stat-item {
      display: flex;
      align-items: center;
      margin: 0 10px;
      font-size: 13px;
    }
    .stat-icon {
      margin-right: 4px;
      font-size: 14px;
    }
    #wrap {
      display: flex;
      height: calc(100vh - 56px);
      position: relative;
    }
    #map {
      flex: 1;
      position: relative;
    }
    #panel {
      width: 300px;
      border-left: 1px solid #d1d9e6;
      padding: 12px;
      box-sizing: border-box;
      background: rgba(255, 255, 255, 0.95);
      overflow: auto;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.08);
      z-index: 1;
    }
    .poi {
      padding: 8px;
      border-bottom: 1px solid #eaeef2;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .poi:hover {
      background-color: #f7f9fc;
      transform: translateX(3px);
    }
    .poi.highlighted {
      background-color: #edf2ff;
      border-left: 3px solid #4a6fa5;
    }
    .hint {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      border: 1px solid #d1d9e6;
    }
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 16px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      border: 1px solid #d1d9e6;
    }
    #infoWindow {
      position: absolute;
      top: 20px;
      right: 320px;
      width: 280px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      padding: 14px;
      z-index: 1000;
      display: none;
      border: 1px solid #d1d9e6;
    }
    #infoWindow h3 {
      margin-top: 0;
      color: #4a6fa5;
      border-bottom: 1px solid #eaeef2;
      padding-bottom: 6px;
      font-size: 16px;
    }
    #infoWindow .close {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-size: 16px;
      color: #a0aec0;
    }
    #infoWindow .close:hover {
      color: #4a6fa5;
    }
    #infoWindow .info-item {
      margin: 6px 0;
      font-size: 13px;
    }
    #infoWindow .info-label {
      font-weight: bold;
      color: #4a6fa5;
    }
    .status-badge {
      display: inline-block;
      padding: 2px 5px;
      border-radius: 3px;
      color: white;
      font-size: 11px;
      margin-left: 6px;
    }
    .overseas-panel {
      position: absolute;
      bottom: 50px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 6px;
      padding: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      z-index: 1000;
      width: 180px;
      border: 1px solid #d1d9e6;
      transition: all 0.3s ease;
    }
    .overseas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      margin-bottom: 5px;
      font-size: 13px;
    }
    .overseas-panel h4 {
      margin: 0;
      color: #4a6fa5;
      font-size: 13px;
    }
    .overseas-list {
      max-height: 150px;
      overflow-y: auto;
      font-size: 11px;
    }
    .overseas-item {
      padding: 4px 0;
      border-bottom: 1px solid #f1f5f9;
      line-height: 1.3;
    }
    .overseas-item:last-child {
      border-bottom: none;
    }
    .toggle-icon {
      font-size: 12px;
      color: #a0aec0;
    }
    .overseas-panel.collapsed {
      width: 140px;
    }
    .overseas-panel.collapsed .overseas-list {
      display: none;
    }
    .map-controls {
      position: absolute;
      top: 10px;
      right: 320px;
      z-index: 1000;
    }
    .map-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #d1d9e6;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .map-btn:hover {
      background: #f7f9fc;
    }
    .link-button {
      display: inline-block;
      margin-top: 8px;
      padding: 4px 8px;
      background-color: #4a6fa5;
      color: white;
      text-decoration: none;
      border-radius: 3px;
      font-size: 12px;
    }
    .link-button:hover {
      background-color: #3a7bd5;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>é»æ·±0905ç”Ÿæ—¥åº”æ´æ±‡æ€»</h1>
    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-icon">ğŸ“Š</span>
        <span id="totalScreens">å¤§å±æ•°: 0</span>
      </div>
      <div class="stat-item">
        <span class="stat-icon">ğŸ¢</span>
        <span id="tonglouCount">ç—›æ¥¼æ•°: 0</span>
      </div>
      <div class="stat-item">
        <span class="stat-icon">ğŸ›ï¸</span>
        <span id="mallCount">å•†åœºæ•°: 0</span>
      </div>
      <div class="stat-item">
        <span class="stat-icon">ğŸ</span>
        <span id="specialCount">ç‰¹æ®Šåº”æ´: 0</span>
      </div>
    </div>
  </div>

  <div id="wrap">
    <div id="map" style="width:100%;height:100%;"></div>
    <div id="panel">
      <h3>ç­›é€‰</h3>
      <div>
        <label>é€‰æ‹©æ—¥æœŸ: <input type="date" id="datePicker" /></label>
      </div>
      <h4 style="margin-top:12px;">è§†çª—å†… POI <span id="poiCount"></span></h4>
      <div id="list"></div>
    </div>
    <div id="hint" class="hint" style="display: none;">åŒå‡»åœ°å›¾è¿”å›å…¨å›½è§†å›¾</div>
    <div id="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
    <div id="infoWindow">
      <span class="close">&times;</span>
      <h3 id="infoTitle"></h3>
      <div class="info-item"><span class="info-label">çœä»½:</span> <span id="infoProvince"></span></div>
      <div class="info-item"><span class="info-label">åŸå¸‚:</span> <span id="infoCity"></span></div>
      <div class="info-item"><span class="info-label">æ—¥æœŸ:</span> <span id="infoDate"></span></div>
      <div class="info-item"><span class="info-label">æ—¶é—´:</span> <span id="infoTime"></span></div>
      <div class="info-item"><span class="info-label">å±å¹•æ•°:</span> <span id="infoScreens"></span></div>
      <div class="info-item"><span class="info-label">è´Ÿè´£äºº:</span> <span id="infoOwner"></span></div>
      <div class="info-item"><span class="info-label">çŠ¶æ€:</span> <span id="infoStatus"></span></div>
      <div class="info-item"><span class="info-label">ç±»å‹:</span> <span id="infoType"></span></div>
      <div class="info-item"><span class="info-label">å¤‡æ³¨:</span> <span id="infoInfo"></span></div>
      <div id="infoLinkContainer" style="display: none;">
        <a id="infoLink" class="link-button" href="#" target="_blank">æŸ¥çœ‹è¯¦æƒ…</a>
      </div>
    </div>
    <div id="overseasPanel" class="overseas-panel">
      <div class="overseas-header" onclick="toggleOverseasPanel()">
        <h4>æµ·å¤–åº”æ´ç‚¹ <span id="overseasCount">(0)</span></h4>
        <span class="toggle-icon">â–¼</span>
      </div>
      <div id="overseasList" class="overseas-list"></div>
    </div>
    <div class="map-controls">
      <button class="map-btn" onclick="resetMapView()">é‡ç½®è§†å›¾</button>
    </div>
  </div>

  <script src="data.js"></script>

  <script>
  let allData = [];
  let highlightedPoi = null;
  let statsInterval = null;
  let overseasData = [];
  let isOverseasPanelCollapsed = false;

  // çŠ¶æ€å’Œç±»å‹é¢œè‰²æ˜ å°„
  const statusColor = {
    "å·²è§£é”": "#28a745",
    "æ— ä»»åŠ¡": "#6c757d",
    "æ²Ÿé€šä¸­": "#ff7f11"
  };

  const typeColor = {
    "ç—›æ¥¼": "#64b5f6",
    "ç‰¹æ®Šåº”æ´": "#26a69a",
    "": "#4a6fa5" // é»˜è®¤é¢œè‰²
  };

  // çŠ¶æ€å’Œç±»å‹æ’åºä¼˜å…ˆçº§
  const statusPriority = {
    "ç—›æ¥¼": 1,
    "ç‰¹æ®Šåº”æ´": 2,
    "å·²è§£é”": 3,
    "æ— ä»»åŠ¡": 4,
    "æ²Ÿé€šä¸­": 5
  };

  // ä¸­å›½çœä»½åˆ—è¡¨ï¼ˆç”¨äºè¯†åˆ«æµ·å¤–ç‚¹ï¼‰
  const chinaProvinces = [
    "åŒ—äº¬", "å¤©æ´¥", "ä¸Šæµ·", "é‡åº†", "æ²³åŒ—", "å±±è¥¿", "è¾½å®", "å‰æ—", "é»‘é¾™æ±Ÿ",
    "æ±Ÿè‹", "æµ™æ±Ÿ", "å®‰å¾½", "ç¦å»º", "æ±Ÿè¥¿", "å±±ä¸œ", "æ²³å—", "æ¹–åŒ—", "æ¹–å—",
    "å¹¿ä¸œ", "æµ·å—", "å››å·", "è´µå·", "äº‘å—", "é™•è¥¿", "ç”˜è‚ƒ", "é’æµ·", "å°æ¹¾",
    "å†…è’™å¤", "å¹¿è¥¿", "è¥¿è—", "å®å¤", "æ–°ç–†", "é¦™æ¸¯", "æ¾³é—¨"
  ];

  const chart = echarts.init(document.getElementById('map'));
  const hint = document.getElementById('hint');
  const loading = document.getElementById('loading');
  const infoWindow = document.getElementById('infoWindow');
  const poiCount = document.getElementById('poiCount');
  const totalScreens = document.getElementById('totalScreens');
  const tonglouCount = document.getElementById('tonglouCount');
  const mallCount = document.getElementById('mallCount');
  const specialCount = document.getElementById('specialCount');
  const overseasPanel = document.getElementById('overseasPanel');
  const overseasCount = document.getElementById('overseasCount');
  const overseasList = document.getElementById('overseasList');
  const infoLinkContainer = document.getElementById('infoLinkContainer');
  const infoLink = document.getElementById('infoLink');

  const loadedMaps = new Set(['china']);
  let currentMap = 'china';
  let currentProvince = '';

  // åˆ‡æ¢æµ·å¤–ç‚¹é¢æ¿çš„å±•å¼€/æ”¶èµ·çŠ¶æ€
  function toggleOverseasPanel() {
    isOverseasPanelCollapsed = !isOverseasPanelCollapsed;
    if (isOverseasPanelCollapsed) {
      overseasPanel.classList.add('collapsed');
      overseasPanel.querySelector('.toggle-icon').textContent = 'â–º';
    } else {
      overseasPanel.classList.remove('collapsed');
      overseasPanel.querySelector('.toggle-icon').textContent = 'â–¼';
    }
  }

  // é‡ç½®åœ°å›¾è§†å›¾
  function resetMapView() {
    chart.setOption({
      geo: {
        map: 'china',
        center: undefined,
        zoom: 1.8
      }
    });
    currentMap = 'china';
    currentProvince = '';
    updateMap(document.getElementById('datePicker').value);
  }

  // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
  function setDefaultDate() {
    const today = new Date();
    const yyyy = today.getFullYear();
    let mm = today.getMonth() + 1;
    let dd = today.getDate();

    if (mm < 10) mm = '0' + mm;
    if (dd < 10) dd = '0' + dd;

    const formattedToday = `${yyyy}-${mm}-${dd}`;
    document.getElementById('datePicker').value = formattedToday;

    return formattedToday;
  }

  // æ›´æ–°ç»Ÿè®¡æ•°æ®
  function updateStats() {
    // è®¡ç®—æ€»å±å¹•æ•°
    const total = allData.reduce((sum, item) => sum + (item.count || 1), 0);
    totalScreens.textContent = `å¤§å±æ•°: ${total}`;

    // è®¡ç®—ç—›æ¥¼æ•°
    const tonglou = allData.filter(item => item.type === "ç—›æ¥¼").length;
    tonglouCount.textContent = `ç—›æ¥¼æ•°: ${tonglou}`;

    // è®¡ç®—ç‰¹æ®Šåº”æ´æ•°
    const special = allData.filter(item => item.type === "ç‰¹æ®Šåº”æ´").length;
    specialCount.textContent = `ç‰¹æ®Šåº”æ´: ${special}`;

    // è®¡ç®—å•†åœºæ•°ï¼ˆå‡è®¾æ‰€æœ‰ç‚¹éƒ½æ˜¯å•†åœºï¼‰
    mallCount.textContent = `å•†åœºæ•°: ${allData.length}`;

    // æ›´æ–°æµ·å¤–ç‚¹è®¡æ•°
    overseasCount.textContent = `(${overseasData.length})`;
  }

  // æ˜¾ç¤ºæµ·å¤–ç‚¹é¢æ¿
  function updateOverseasPanel() {
    if (overseasData.length > 0) {
      overseasPanel.style.display = 'block';
      overseasList.innerHTML = '';

      overseasData.forEach(item => {
        const div = document.createElement('div');
        div.className = 'overseas-item';
        div.innerHTML = `
          <strong>${item.poi}</strong><br>
          <span>${item.province} Â· ${item.city}</span>
        `;
        overseasList.appendChild(div);
      });
    } else {
      overseasPanel.style.display = 'none';
    }
  }

  // æ»šåŠ¨æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
  function startStatsAnimation() {
    if (statsInterval) clearInterval(statsInterval);

    const stats = [
      {id: 'totalScreens', label: 'å¤§å±æ•°'},
      {id: 'tonglouCount', label: 'ç—›æ¥¼æ•°'},
      {id: 'specialCount', label: 'ç‰¹æ®Šåº”æ´'},
      {id: 'mallCount', label: 'å•†åœºæ•°'}
    ];

    let currentStat = 0;

    statsInterval = setInterval(() => {
      const stat = stats[currentStat];
      const element = document.getElementById(stat.id);

      // æ·»åŠ é«˜äº®åŠ¨ç”»
      element.style.transition = 'all 0.3s ease';
      element.style.color = '#ffffff';
      element.style.textShadow = '0 0 5px rgba(255, 255, 255, 0.8)';

      setTimeout(() => {
        element.style.color = '';
        element.style.textShadow = '';
      }, 500);

      currentStat = (currentStat + 1) % stats.length;
    }, 2000);
  }

  function loadDataFromWindow() {
    try {
      if (!window.data) throw new Error('data.js æœªå®šä¹‰ window.data');

      // åˆ†ç¦»å›½å†…å’Œæµ·å¤–æ•°æ®
      const domesticData = [];
      overseasData = [];

      window.data.forEach(item => {
        const isOverseas = !chinaProvinces.includes(item.province);
        const processedItem = {
          province: item.province,
          city: item.city,
          poi: item.name,
          date_raw: item.date,
          date_list: item.date_list || [],
          time: item.time || [],
          count: item.screens ? parseInt(String(item.screens).replace(/\s+/g,'')) || 1 : 1,
          tag: item.owner,
          status: item.status,
          type: item.type || "",
          info: item.info || "",
          link: item.link || "",
          lat: item.y,
          lng: item.x,
          isOverseas: isOverseas
        };

        if (isOverseas) {
          overseasData.push(processedItem);
        } else {
          domesticData.push(processedItem);
        }
      });

      allData = domesticData;

      loading.style.display = 'none';
      initMap();

      // è®¾ç½®é»˜è®¤æ—¥æœŸå¹¶æ›´æ–°åœ°å›¾
      const defaultDate = setDefaultDate();
      updateMap(defaultDate);

      // æ›´æ–°ç»Ÿè®¡æ•°æ®
      updateStats();

      // æ›´æ–°æµ·å¤–ç‚¹é¢æ¿
      updateOverseasPanel();

      // å¯åŠ¨ç»Ÿè®¡æ•°å­—åŠ¨ç”»
      startStatsAnimation();
    } catch (err) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', err);
      loading.textContent = 'æ•°æ®åŠ è½½å¤±è´¥: ' + (err.message || err);
    }
  }

  // åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…
  function isPointInPolygon(point, polygon) {
    const x = point[0], y = point[1];
    let inside = false;

    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
      const xi = polygon[i][0], yi = polygon[i][1];
      const xj = polygon[j][0], yj = polygon[j][1];

      const intersect = ((yi > y) !== (yj > y)) &&
        (x < (xj - xi) * (y - yi) / (yj - yi) + xi);

      if (intersect) inside = !inside;
    }

    return inside;
  }

  // è·å–çœä»½çš„è¾¹ç•Œåæ ‡
  function getProvinceBounds(geoJson, provinceName) {
    const province = geoJson.features.find(f => f.properties.name === provinceName);
    if (!province) return null;

    // æå–çœä»½çš„æ‰€æœ‰è¾¹ç•Œåæ ‡ç‚¹
    const bounds = [];
    if (province.geometry.type === 'Polygon') {
      bounds.push(...province.geometry.coordinates[0]);
    } else if (province.geometry.type === 'MultiPolygon') {
      province.geometry.coordinates.forEach(polygon => {
        bounds.push(...polygon[0]);
      });
    }

    return bounds;
  }

  // ç­›é€‰å±äºå½“å‰çœä»½çš„POI
  function filterByProvince(data, provinceName, geoJson) {
    if (provinceName === 'å…¨å›½' || !provinceName) return data;

    const bounds = getProvinceBounds(geoJson, provinceName);
    if (!bounds) return data.filter(item => item.province === provinceName);

    return data.filter(item => {
      // é¦–å…ˆæ£€æŸ¥çœä»½åç§°æ˜¯å¦åŒ¹é…
      if (item.province === provinceName) return true;

      // å¦‚æœçœä»½åç§°ä¸åŒ¹é…ï¼Œä½†åæ ‡åœ¨çœä»½è¾¹ç•Œå†…ï¼Œä¹ŸåŒ…å«
      const point = [item.lng, item.lat];
      return isPointInPolygon(point, bounds);
    });
  }

  // è·å–POIç‚¹çš„é¢œè‰²
  function getPoiColor(item) {
    // ä¼˜å…ˆä½¿ç”¨typeå­—æ®µç¡®å®šé¢œè‰²
    if (item.type && typeColor[item.type]) {
      return typeColor[item.type];
    }
    // å…¶æ¬¡ä½¿ç”¨statuså­—æ®µç¡®å®šé¢œè‰²
    if (item.status && statusColor[item.status]) {
      return statusColor[item.status];
    }
    // é»˜è®¤é¢œè‰²
    return typeColor[""];
  }

  // æ˜¾ç¤ºä¿¡æ¯çª—å£
  function showInfoWindow(poiData) {
    document.getElementById('infoTitle').textContent = poiData.poi;
    document.getElementById('infoProvince').textContent = poiData.province;
    document.getElementById('infoCity').textContent = poiData.city;
    document.getElementById('infoDate').textContent = poiData.date_raw;
    document.getElementById('infoTime').textContent = poiData.time && poiData.time.length > 0 ? poiData.time[0] : 'æœªçŸ¥';
    document.getElementById('infoScreens').textContent = poiData.count;
    document.getElementById('infoOwner').textContent = poiData.tag;
    
    const statusElement = document.getElementById('infoStatus');
    statusElement.textContent = poiData.status;
    statusElement.className = 'status-badge';
    statusElement.style.backgroundColor = statusColor[poiData.status] || '#6c757d';
    
    const typeElement = document.getElementById('infoType');
    typeElement.textContent = poiData.type || "æ™®é€šåº”æ´";
    typeElement.className = 'status-badge';
    typeElement.style.backgroundColor = getPoiColor(poiData);
    
    document.getElementById('infoInfo').textContent = poiData.info || 'æ— å¤‡æ³¨';
    
    // å¤„ç†é“¾æ¥
    if (poiData.link) {
      infoLink.href = poiData.link;
      infoLinkContainer.style.display = 'block';
    } else {
      infoLinkContainer.style.display = 'none';
    }
    
    infoWindow.style.display = 'block';
  }

  // å…³é—­ä¿¡æ¯çª—å£
  function closeInfoWindow() {
    infoWindow.style.display = 'none';
    if (highlightedPoi) {
      highlightedPoi.classList.remove('highlighted');
      highlightedPoi = null;
    }
  }

  function initMap() {
    fetch('100000_full.json')
      .then(r => r.json())
      .then(geoJson => {
        geoJson.features.forEach(f => {
          if (f.properties.name.includes("ç‰¹åˆ«è¡Œæ”¿åŒº")) f.properties.name = f.properties.name.replace("ç‰¹åˆ«è¡Œæ”¿åŒº", "");
        });
        geoJson.features.forEach(f => {
          if (f.properties.name === "æ²³åŒ—çœ") {
            f.geometry.coordinates = f.geometry.coordinates.map(poly => poly.map(ring => ring.map(coord => [coord[0], coord[1]-0.8])));
          }
        });

        echarts.registerMap('china', geoJson);

        const option = {
          backgroundColor: 'rgba(240, 244, 248, 0.6)',
          tooltip: {
            trigger: 'item',
            formatter: function(params) {
              if (!params.data) return '';
              return `${params.data.name}<br>${params.data.city}<br>${params.data.date_raw}`;
            }
          },
          geo: {
            map: 'china',
            roam: true,
            zoom: 1.8,
            center: [105, 36],
            label: {
              show: true,
              emphasis: { show: true },
              color: '#4a6fa5'
            },
            itemStyle: {
              areaColor: 'rgba(200, 210, 230, 0.6)',
              borderColor: '#8fa6d3',
              borderWidth: 1,
              emphasis: {
                areaColor: 'rgba(140, 160, 210, 0.8)',
                borderWidth: 1.5
              }
            },
            scaleLimit: { min: 1, max: 20 }
          },
          series: [{
            name: 'poi',
            type: 'scatter',
            coordinateSystem: 'geo',
            symbolSize: function(val,params) {
              const item = params.data;
              if (item.type === "ç—›æ¥¼" || item.type === "ç‰¹æ®Šåº”æ´") {
                return 12;  
              }
              return Math.max(10, Math.min(20, val[2]*5));
            },
            data: [],
            encode: { tooltip: [0] },
            itemStyle: {
              color: function(params) {
                return getPoiColor(params.data);
              },
              borderColor: '#fff',
              borderWidth: 1,
              opacity: 0.9
            },
            emphasis: {
              itemStyle: {
                borderWidth: 2,
                opacity: 1,
                shadowBlur: 8,
                shadowColor: 'rgba(0, 0, 0, 0.3)'
              }
            }
          }]
        };

        chart.setOption(option);

        chart.on('dblclick', function(params) {
          if (currentMap === 'china' && params.componentType === 'geo' && params.name) {
            const provinceName = params.name;
            currentProvince = provinceName;
            const provinceFeature = geoJson.features.find(f=>f.properties.name===provinceName);
            if(provinceFeature){
              const adcode = provinceFeature.properties.adcode;
              fetch(`code/${adcode}_full.json`)
                .then(r=>r.json())
                .then(cityGeoJson=>{
                  const mapName=`city_${adcode}`;
                  echarts.registerMap(mapName, cityGeoJson);
                  loadedMaps.add(mapName);
                  chart.setOption({geo:{map:mapName, center:undefined, zoom:1}});
                  currentMap=mapName;

                  // æ›´æ–°åœ°å›¾æ˜¾ç¤ºï¼Œåªæ˜¾ç¤ºå½“å‰çœä»½çš„POI
                  updateMap(document.getElementById('datePicker').value);

                  hint.style.display='block';
                  hint.textContent=`åŒå‡»åœ°å›¾è¿”å›å…¨å›½è§†å›¾ (å½“å‰: ${provinceName})`;
                  setTimeout(()=>{hint.style.display='none';},5000);
                }).catch(err=>console.error('åŠ è½½å¸‚çº§åœ°å›¾å¤±è´¥:',err));
            }
          } else if(currentMap!=='china') {
            resetMapView();
            hint.style.display='block';
            hint.textContent='åŒå‡»çœä»½è¿›å…¥å¸‚çº§è§†å›¾';
            setTimeout(()=>{hint.style.display='none';},5000);
          }
        });

        // ç‚¹å‡»POIç‚¹æ˜¾ç¤ºä¿¡æ¯çª—å£
        chart.on('click', function(params) {
          if (params.data) {
            const poiData = allData.find(item =>
              item.poi === params.data.name &&
              item.lng === params.data.value[0] &&
              item.lat === params.data.value[1]
            );

            if (poiData) {
              showInfoWindow(poiData);

              // é«˜äº®æ˜¾ç¤ºå¯¹åº”çš„åˆ—è¡¨é¡¹
              const listItems = document.querySelectorAll('.poi');
              listItems.forEach(item => {
                item.classList.remove('highlighted');
                if (item.textContent.includes(poiData.poi)) {
                  item.classList.add('highlighted');
                  highlightedPoi = item;
                  item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
              });
            }
          }
        });

        hint.style.display='block';
        hint.textContent='åŒå‡»çœä»½è¿›å…¥å¸‚çº§è§†å›¾';
        setTimeout(()=>{hint.style.display='none';},5000);

        // å­˜å‚¨geoJsonä¾›åç»­ä½¿ç”¨
        window.chinaGeoJson = geoJson;
      }).catch(err=>{
        console.error('åŠ è½½åœ°å›¾å¤±è´¥', err);
        loading.textContent='åœ°å›¾åŠ è½½å¤±è´¥: '+err.message;
      });

    // å…³é—­æŒ‰é’®äº‹ä»¶
    document.querySelector('.close').addEventListener('click', closeInfoWindow);

    // ç‚¹å‡»åœ°å›¾å…¶ä»–åŒºåŸŸå…³é—­ä¿¡æ¯çª—å£
    chart.getDom().addEventListener('click', function(e) {
      if (e.target === chart.getDom()) {
        closeInfoWindow();
      }
    });
  }

  function isVisible(p, selectedDate){
    if(!selectedDate) return true;
    if(p.date_list && p.date_list.length>0) return p.date_list.includes(selectedDate);
    if(!p.date_raw) return true;
    const year = (new Date()).getFullYear();
    const raw = p.date_raw.replace(/[ï¼ˆï¼‰\(\)].*$/,'').replace(/ï½/g,'-').replace(/â€”/g,'-').replace(/\s+/g,'');
    const parts = raw.split('-').map(s=>s.trim()).filter(Boolean);
    function norm(s){
      const m = s.split('.');
      if(m.length===2){ const mm=m[0].padStart(2,'0'), dd=m[1].padStart(2,'0'); return `${year}-${mm}-${dd}`; }
      return null;
    }
    let start,end;
    if(parts.length===1){ start=norm(parts[0]); end=norm(parts[0]); } else { start=norm(parts[0]); end=norm(parts[1]); }
    if(!start||!end) return true;
    const d=new Date(selectedDate), s=new Date(start), e=new Date(end);
    return s<=d&&d<=e;
  }

  function updateMap(selectedDate){
    selectedDate = selectedDate || document.getElementById('datePicker').value;
    let visible = allData.filter(p=>isVisible(p, selectedDate));

    // å¦‚æœå½“å‰æ˜¯çœçº§åœ°å›¾ï¼Œåªæ˜¾ç¤ºå½“å‰çœä»½çš„POI
    if (currentMap !== 'china' && currentProvince) {
      visible = filterByProvince(visible, currentProvince, window.chinaGeoJson);
    }

    const seriesData = visible.map(p=>({
      name: p.poi,
      value: [p.lng, p.lat, p.count || 1],
      status: p.status,
      type: p.type,
      city: p.city,
      date_raw: p.date_raw,
      screens: p.count,
      province: p.province
    }));

    chart.setOption({
      series: [{
        data: seriesData,
        symbolSize: function(val){ return Math.max(10, Math.min(20, val[2]*5)); },
        itemStyle: {
          color: function(params) {
            return getPoiColor(params.data);
          }
        }
      }]
    });

    renderList(visible);
  }

  function renderList(list){
    const c=document.getElementById('list');
    c.innerHTML='';

    // æ›´æ–°POIè®¡æ•°
    poiCount.textContent = `(${list.length}ä¸ª)`;

    if(list.length===0){
      c.innerHTML='<div class="poi">æ²¡æœ‰åŒ¹é…çš„POI</div>';
      return;
    }

    // æ’åºï¼šç—›æ¥¼ä¼˜å…ˆï¼Œç„¶åæŒ‰çŠ¶æ€ä¼˜å…ˆçº§æ’åºï¼Œæœ€åæŒ‰åç§°æ’åº
    list.sort((a, b) => {
      // æŒ‰ç±»å‹ä¼˜å…ˆçº§æ’åº
      const typeOrder = (statusPriority[a.type] || 99) - (statusPriority[b.type] || 99);
      if (typeOrder !== 0) return typeOrder;
      
      // æŒ‰çŠ¶æ€ä¼˜å…ˆçº§æ’åº
      const statusOrder = (statusPriority[a.status] || 99) - (statusPriority[b.status] || 99);
      if (statusOrder !== 0) return statusOrder;

      // çŠ¶æ€ç›¸åŒæŒ‰åç§°æ’åº
      return a.poi.localeCompare(b.poi);
    });

    list.forEach(p=>{
      const el=document.createElement('div');
      el.className='poi';

      el.innerHTML=`
        <strong>${p.poi}</strong>
        <span class="status-badge" style="background-color: ${getPoiColor(p)}">${p.type || p.status}</span>
        <div style="font-size:12px;color:#666">${p.city} Â· ${p.date_raw}</div>
      `;
      el.onclick=()=>{
        // å®šä½åˆ°POI
        chart.setOption({geo:{center:[p.lng,p.lat], zoom:8}});

        // æ˜¾ç¤ºä¿¡æ¯çª—å£
        const poiData = allData.find(item =>
          item.poi === p.poi &&
          item.lng === p.lng &&
          item.lat === p.lat
        );

        if (poiData) {
          showInfoWindow(poiData);

          // é«˜äº®å½“å‰é¡¹
          document.querySelectorAll('.poi').forEach(item => item.classList.remove('highlighted'));
          el.classList.add('highlighted');
          highlightedPoi = el;
        }
      };
      c.appendChild(el);
    });
  }

  document.getElementById('datePicker').addEventListener('change', function() {
    updateMap(this.value);
  });

  window.addEventListener('load', loadDataFromWindow);
  </script>
</body>
</html>
